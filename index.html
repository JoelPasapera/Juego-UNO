<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNO - El Juego de Cartas</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --uno-red: #ED1C24;
            --uno-blue: #0066B3;
            --uno-green: #00A651;
            --uno-yellow: #FFCD05;
            --uno-black: #1a1a2e;
            --uno-dark: #0f0f1a;
            --card-width: 70px;
            --card-height: 105px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1a 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .screen { display: none; min-height: 100vh; }
        .screen.active { display: flex; }

        /* MENU */
        .main-menu {
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: radial-gradient(ellipse at center, rgba(237,28,36,0.1) 0%, transparent 70%);
        }

        .logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 100px;
            font-weight: 900;
            margin-bottom: 10px;
            display: flex;
            gap: 5px;
        }

        .logo span:nth-child(1) { color: var(--uno-red); text-shadow: 0 0 30px var(--uno-red); }
        .logo span:nth-child(2) { color: var(--uno-yellow); text-shadow: 0 0 30px var(--uno-yellow); }
        .logo span:nth-child(3) { color: var(--uno-green); text-shadow: 0 0 30px var(--uno-green); }

        .subtitle {
            font-size: 18px;
            color: rgba(255,255,255,0.5);
            margin-bottom: 50px;
            letter-spacing: 5px;
        }

        .menu-buttons { display: flex; flex-direction: column; gap: 15px; width: 300px; }

        .btn {
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            font-weight: 700;
            padding: 16px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .btn-primary { background: linear-gradient(135deg, var(--uno-red), #ff4757); color: white; }
        .btn-secondary { background: linear-gradient(135deg, var(--uno-blue), #1e90ff); color: white; }
        .btn-tertiary { background: linear-gradient(135deg, var(--uno-green), #2ed573); color: white; }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .btn-small { padding: 10px 20px; font-size: 11px; }

        /* GAME */
        .game-screen {
            flex-direction: column;
            padding: 15px;
            background: radial-gradient(ellipse at 50% 30%, rgba(0,102,179,0.1) 0%, transparent 50%);
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: rgba(0,0,0,0.5);
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .game-info { display: flex; gap: 20px; align-items: center; }

        .turn-indicator span:first-child { color: rgba(255,255,255,0.6); font-size: 13px; }
        .turn-name { 
            font-family: 'Orbitron', sans-serif; 
            color: var(--uno-yellow); 
            font-weight: 700;
            font-size: 16px;
            margin-left: 8px;
        }

        .direction-box {
            background: rgba(255,255,255,0.1);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 13px;
        }

        .direction-arrow { font-size: 18px; margin-left: 5px; }

        /* OPPONENTS */
        .opponents-area {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .opponent {
            background: rgba(255,255,255,0.05);
            border: 2px solid transparent;
            border-radius: 15px;
            padding: 15px 20px;
            min-width: 120px;
            text-align: center;
            transition: all 0.3s;
        }

        .opponent.active-turn {
            border-color: var(--uno-yellow);
            background: rgba(255,205,5,0.15);
            box-shadow: 0 0 20px rgba(255,205,5,0.3);
        }

        .opponent-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6b5b95, var(--uno-blue));
            margin: 0 auto 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
        }

        .opponent-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .opponent-cards {
            display: flex;
            justify-content: center;
            margin-bottom: 5px;
        }

        .mini-card {
            width: 24px;
            height: 36px;
            background: linear-gradient(145deg, #2a2a3e, #1a1a2e);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 4px;
            margin: 0 -6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 7px;
            color: var(--uno-red);
            font-weight: 900;
        }

        .card-count {
            font-family: 'Orbitron', sans-serif;
            font-size: 18px;
            color: var(--uno-yellow);
            font-weight: 700;
        }

        /* PLAY AREA */
        .play-area {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 60px;
            padding: 30px;
            flex: 1;
        }

        .pile-section { text-align: center; }

        .pile-label {
            font-size: 11px;
            color: rgba(255,255,255,0.4);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 10px;
        }

        .deck-pile {
            width: var(--card-width);
            height: var(--card-height);
            background: linear-gradient(145deg, #2a2a3e, #1a1a2e);
            border: 3px solid rgba(255,255,255,0.15);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .deck-pile::before {
            content: '';
            position: absolute;
            width: 40%;
            height: 80%;
            background: rgba(237,28,36,0.3);
            border-radius: 50%;
            transform: rotate(45deg);
        }

        .deck-pile:hover { transform: scale(1.05); }

        .deck-text {
            font-family: 'Orbitron', sans-serif;
            font-size: 16px;
            font-weight: 900;
            color: var(--uno-red);
            position: relative;
            z-index: 1;
        }

        .discard-section { position: relative; }

        .color-indicator {
            position: absolute;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0,0,0,0.5);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
        }

        .color-dot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .color-dot.red { background: var(--uno-red); }
        .color-dot.blue { background: var(--uno-blue); }
        .color-dot.green { background: var(--uno-green); }
        .color-dot.yellow { background: var(--uno-yellow); }

        /* UNO CARD */
        .uno-card {
            width: var(--card-width);
            height: var(--card-height);
            border-radius: 10px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            flex-shrink: 0;
        }

        .uno-card::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(30deg);
            width: 50%;
            height: 120%;
            background: rgba(255,255,255,0.9);
            border-radius: 50%;
        }

        .uno-card.red { background: var(--uno-red); }
        .uno-card.blue { background: var(--uno-blue); }
        .uno-card.green { background: var(--uno-green); }
        .uno-card.yellow { background: var(--uno-yellow); }
        .uno-card.wild {
            background: conic-gradient(var(--uno-red) 0deg 90deg, var(--uno-yellow) 90deg 180deg, var(--uno-green) 180deg 270deg, var(--uno-blue) 270deg 360deg);
        }

        .card-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Orbitron', sans-serif;
            font-size: 28px;
            font-weight: 900;
            z-index: 1;
        }

        .uno-card.red .card-value { color: var(--uno-red); }
        .uno-card.blue .card-value { color: var(--uno-blue); }
        .uno-card.green .card-value { color: var(--uno-green); }
        .uno-card.yellow .card-value { color: #b8960a; }
        .uno-card.wild .card-value { color: white; font-size: 12px; text-shadow: 0 1px 3px rgba(0,0,0,0.5); }

        .card-corner {
            position: absolute;
            font-family: 'Orbitron', sans-serif;
            font-size: 10px;
            font-weight: 700;
            color: white;
        }

        .card-corner.top { top: 5px; left: 5px; }
        .card-corner.bottom { bottom: 5px; right: 5px; transform: rotate(180deg); }

        /* PLAYER AREA */
        .player-area {
            background: rgba(0,0,0,0.5);
            border-radius: 20px;
            padding: 20px;
            margin-top: auto;
        }

        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .player-info { display: flex; align-items: center; gap: 12px; }

        .player-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--uno-yellow), var(--uno-red));
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            font-size: 18px;
        }

        .player-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 16px;
            color: var(--uno-yellow);
        }

        .player-card-count {
            font-size: 13px;
            color: rgba(255,255,255,0.6);
        }

        .player-actions { display: flex; gap: 10px; }

        .uno-button {
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            font-weight: 900;
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.3s;
            background: linear-gradient(135deg, #555, #333);
            color: #888;
        }

        .uno-button.active {
            background: linear-gradient(135deg, var(--uno-red), #ff4757);
            color: white;
            cursor: pointer;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .pass-button {
            font-family: 'Orbitron', sans-serif;
            font-size: 11px;
            padding: 10px 18px;
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            cursor: pointer;
            display: none;
        }

        .pass-button.visible { display: block; }
        .pass-button:hover { background: rgba(255,255,255,0.2); }

        /* PLAYER HAND */
        .player-hand {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 8px;
            padding: 15px;
            min-height: 130px;
            background: rgba(255,255,255,0.03);
            border-radius: 15px;
        }

        .player-hand .uno-card:hover {
            transform: translateY(-12px);
            z-index: 10;
        }

        .player-hand .uno-card.playable {
            box-shadow: 0 0 0 3px var(--uno-yellow), 0 4px 15px rgba(0,0,0,0.4);
        }

        .player-hand .uno-card.not-playable {
            opacity: 0.4;
            filter: grayscale(40%);
        }

        .player-hand .uno-card.not-playable:hover {
            transform: none;
        }

        /* COLOR PICKER */
        .color-picker {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .color-picker.active { display: flex; }

        .color-picker-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
            margin-bottom: 30px;
        }

        .color-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .color-option {
            width: 90px;
            height: 90px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
            color: white;
        }

        .color-option:hover { transform: scale(1.1); border-color: white; }
        .color-option.red { background: var(--uno-red); }
        .color-option.blue { background: var(--uno-blue); }
        .color-option.green { background: var(--uno-green); }
        .color-option.yellow { background: var(--uno-yellow); color: #333; }

        /* WINNER */
        .winner-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .winner-modal.active { display: flex; }

        .winner-trophy { font-size: 80px; animation: bounce 1s infinite; }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .winner-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 48px;
            font-weight: 900;
            background: linear-gradient(135deg, var(--uno-yellow), var(--uno-red));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 20px 0;
        }

        .winner-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
            margin-bottom: 30px;
        }

        .winner-buttons { display: flex; gap: 15px; }

        /* TOAST */
        .toast-container {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            padding: 10px 20px;
            background: rgba(0,0,0,0.9);
            border-radius: 25px;
            font-size: 13px;
            border: 2px solid;
            animation: toastIn 0.3s ease;
        }

        @keyframes toastIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .toast.info { border-color: var(--uno-blue); }
        .toast.success { border-color: var(--uno-green); }
        .toast.warning { border-color: var(--uno-yellow); }
        .toast.error { border-color: var(--uno-red); }

        /* RULES MODAL */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active { display: flex; }

        .modal-content {
            background: linear-gradient(145deg, #1f1f35, #15152a);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 22px;
            color: var(--uno-yellow);
            margin-bottom: 20px;
            text-align: center;
        }

        .rules-text { line-height: 1.8; color: rgba(255,255,255,0.85); }
        .rules-text h4 { color: var(--uno-yellow); margin: 20px 0 10px; font-size: 15px; }
        .rules-text p { margin-bottom: 8px; }

        /* RESPONSIVE */
        @media (max-width: 600px) {
            :root { --card-width: 55px; --card-height: 82px; }
            .logo { font-size: 60px; }
            .card-value { font-size: 22px; }
            .card-corner { font-size: 8px; }
            .player-hand { gap: 5px; }
            .play-area { gap: 30px; padding: 15px; }
        }
    </style>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>

    <!-- MENU SCREEN -->
    <div class="screen main-menu active" id="menuScreen">
        <h1 class="logo"><span>U</span><span>N</span><span>O</span></h1>
        <p class="subtitle">EL JUEGO DE CARTAS</p>
        <div class="menu-buttons">
            <button class="btn btn-primary" onclick="startGame()">üéÆ Jugar</button>
            <button class="btn btn-tertiary" onclick="showRules()">üìñ Reglas</button>
        </div>
    </div>

    <!-- GAME SCREEN -->
    <div class="screen game-screen" id="gameScreen">
        <div class="game-header">
            <div class="game-info">
                <div class="turn-indicator">
                    <span>Turno:</span>
                    <span class="turn-name" id="turnName">-</span>
                </div>
                <div class="direction-box">
                    Direcci√≥n <span class="direction-arrow" id="directionArrow">‚û°Ô∏è</span>
                </div>
            </div>
            <button class="btn btn-small btn-secondary" onclick="backToMenu()">Salir</button>
        </div>

        <div class="opponents-area" id="opponentsArea"></div>

        <div class="play-area">
            <div class="pile-section">
                <div class="deck-pile" onclick="drawCard()" id="deckPile">
                    <span class="deck-text">UNO</span>
                </div>
                <p class="pile-label">Robar</p>
            </div>

            <div class="pile-section discard-section">
                <div id="discardPile"></div>
                <p class="pile-label">Descarte</p>
                <div class="color-indicator">
                    <span>Color:</span>
                    <div class="color-dot" id="colorDot"></div>
                </div>
            </div>
        </div>

        <div class="player-area">
            <div class="player-header">
                <div class="player-info">
                    <div class="player-avatar">T</div>
                    <div>
                        <div class="player-name">T√∫</div>
                        <div class="player-card-count" id="playerCardCount">7 cartas</div>
                    </div>
                </div>
                <div class="player-actions">
                    <button class="pass-button" id="passButton" onclick="passTurn()">Pasar</button>
                    <button class="uno-button" id="unoButton" onclick="callUno()">¬°UNO!</button>
                </div>
            </div>
            <div class="player-hand" id="playerHand"></div>
        </div>
    </div>

    <!-- COLOR PICKER -->
    <div class="color-picker" id="colorPicker">
        <h2 class="color-picker-title">üé® Elige un color</h2>
        <div class="color-options">
            <div class="color-option red" onclick="selectColor('red')">Rojo</div>
            <div class="color-option blue" onclick="selectColor('blue')">Azul</div>
            <div class="color-option green" onclick="selectColor('green')">Verde</div>
            <div class="color-option yellow" onclick="selectColor('yellow')">Amarillo</div>
        </div>
    </div>

    <!-- WINNER MODAL -->
    <div class="winner-modal" id="winnerModal">
        <div class="winner-trophy">üèÜ</div>
        <h1 class="winner-title">¬°VICTORIA!</h1>
        <p class="winner-name" id="winnerName"></p>
        <div class="winner-buttons">
            <button class="btn btn-primary" onclick="startGame()">Jugar de nuevo</button>
            <button class="btn btn-secondary" onclick="backToMenu()">Men√∫</button>
        </div>
    </div>

    <!-- RULES MODAL -->
    <div class="modal-overlay" id="rulesModal">
        <div class="modal-content">
            <h2 class="modal-title">üìñ Reglas del UNO</h2>
            <div class="rules-text">
                <h4>üéØ Objetivo</h4>
                <p>Ser el primero en quedarse sin cartas.</p>
                
                <h4>üÉè C√≥mo jugar</h4>
                <p>‚Ä¢ Juega una carta que coincida en COLOR o N√öMERO con la carta del descarte.</p>
                <p>‚Ä¢ Si no puedes jugar, roba una carta del mazo.</p>
                <p>‚Ä¢ Si la carta robada es jugable, puedes usarla. Si no, pasa tu turno.</p>
                
                <h4>‚ö° Cartas especiales</h4>
                <p><strong>Saltar (‚äò)</strong> ‚Äî El siguiente jugador pierde su turno.</p>
                <p><strong>Reversa (‚ü≤)</strong> ‚Äî Cambia la direcci√≥n del juego.</p>
                <p><strong>+2</strong> ‚Äî El siguiente roba 2 cartas y pierde turno.</p>
                <p><strong>Comod√≠n (‚òÖ)</strong> ‚Äî Ju√©gala cuando quieras y elige el color.</p>
                <p><strong>+4</strong> ‚Äî Elige color y el siguiente roba 4 cartas.</p>
                
                <h4>üì¢ ¬°UNO!</h4>
                <p>Cuando te quede UNA carta, presiona "¬°UNO!" antes de jugarla o recibir√°s 2 cartas de penalizaci√≥n.</p>
            </div>
            <button class="btn btn-primary" onclick="hideRules()" style="width: 100%; margin-top: 20px;">¬°Entendido!</button>
        </div>
    </div>

    <script>
        // ==================== GAME STATE ====================
        var gameState = {
            deck: [],
            discardPile: [],
            players: [],
            currentPlayer: 0,
            direction: 1,
            currentColor: null,
            currentValue: null,
            gameOver: false,
            drawnThisTurn: false,
            pendingWild: null,
            calledUno: false
        };

        var COLORS = ['red', 'blue', 'green', 'yellow'];

        // ==================== UTILITIES ====================
        function showToast(message, type) {
            type = type || 'info';
            var container = document.getElementById('toastContainer');
            var toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(function() {
                if (toast.parentNode) toast.remove();
            }, 2500);
        }

        function showScreen(id) {
            var screens = document.querySelectorAll('.screen');
            for (var i = 0; i < screens.length; i++) {
                screens[i].classList.remove('active');
            }
            document.getElementById(id).classList.add('active');
        }

        // ==================== DECK FUNCTIONS ====================
        function createDeck() {
            var deck = [];
            
            for (var c = 0; c < COLORS.length; c++) {
                var color = COLORS[c];
                // One 0 per color
                deck.push({color: color, value: '0', type: 'number'});
                
                // Two of 1-9 per color
                for (var n = 1; n <= 9; n++) {
                    deck.push({color: color, value: String(n), type: 'number'});
                    deck.push({color: color, value: String(n), type: 'number'});
                }
                
                // Two special cards per color
                for (var s = 0; s < 2; s++) {
                    deck.push({color: color, value: 'skip', type: 'skip'});
                    deck.push({color: color, value: 'reverse', type: 'reverse'});
                    deck.push({color: color, value: 'draw2', type: 'draw2'});
                }
            }
            
            // Wild cards
            for (var w = 0; w < 4; w++) {
                deck.push({color: 'wild', value: 'wild', type: 'wild'});
                deck.push({color: 'wild', value: 'wild4', type: 'wild4'});
            }
            
            return shuffle(deck);
        }

        function shuffle(array) {
            var arr = array.slice();
            for (var i = arr.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = arr[i];
                arr[i] = arr[j];
                arr[j] = temp;
            }
            return arr;
        }

        function dealCards(count, player) {
            for (var i = 0; i < count; i++) {
                if (gameState.deck.length === 0) reshuffleDeck();
                if (gameState.deck.length > 0) {
                    player.hand.push(gameState.deck.pop());
                }
            }
        }

        function reshuffleDeck() {
            if (gameState.discardPile.length <= 1) return;
            var top = gameState.discardPile.pop();
            gameState.deck = shuffle(gameState.discardPile);
            gameState.discardPile = [top];
            showToast('Mazo rebarajado', 'info');
        }

        // ==================== GAME SETUP ====================
        function startGame() {
            document.getElementById('winnerModal').classList.remove('active');
            
            gameState = {
                deck: createDeck(),
                discardPile: [],
                players: [
                    {id: 0, name: 'T√∫', hand: [], isAI: false},
                    {id: 1, name: 'Bot Ana', hand: [], isAI: true},
                    {id: 2, name: 'Bot Carlos', hand: [], isAI: true},
                    {id: 3, name: 'Bot Mar√≠a', hand: [], isAI: true}
                ],
                currentPlayer: 0,
                direction: 1,
                currentColor: null,
                currentValue: null,
                gameOver: false,
                drawnThisTurn: false,
                pendingWild: null,
                calledUno: false
            };

            // Deal 7 cards to each player
            for (var i = 0; i < gameState.players.length; i++) {
                dealCards(7, gameState.players[i]);
            }

            // First card (must be number)
            var firstCard;
            do {
                firstCard = gameState.deck.pop();
                if (firstCard.type !== 'number') {
                    gameState.deck.unshift(firstCard);
                    gameState.deck = shuffle(gameState.deck);
                }
            } while (firstCard.type !== 'number');

            gameState.discardPile.push(firstCard);
            gameState.currentColor = firstCard.color;
            gameState.currentValue = firstCard.value;

            // Random start
            gameState.currentPlayer = Math.floor(Math.random() * 4);

            showScreen('gameScreen');
            render();
            showToast('¬°Comienza el juego!', 'success');

            if (gameState.players[gameState.currentPlayer].isAI) {
                setTimeout(aiTurn, 1200);
            }
        }

        // ==================== RENDERING ====================
        function render() {
            renderOpponents();
            renderDiscard();
            renderHand();
            renderTurnInfo();
            renderButtons();
        }

        function renderOpponents() {
            var container = document.getElementById('opponentsArea');
            container.innerHTML = '';

            for (var i = 1; i < gameState.players.length; i++) {
                var p = gameState.players[i];
                var isActive = i === gameState.currentPlayer;
                var cardCount = p.hand.length;
                var visibleCards = Math.min(cardCount, 4);

                var div = document.createElement('div');
                div.className = 'opponent' + (isActive ? ' active-turn' : '');

                var cardsHtml = '';
                for (var c = 0; c < visibleCards; c++) {
                    cardsHtml += '<div class="mini-card">U</div>';
                }

                div.innerHTML = 
                    '<div class="opponent-avatar">' + p.name.charAt(0) + '</div>' +
                    '<div class="opponent-name">' + p.name + '</div>' +
                    '<div class="opponent-cards">' + cardsHtml + '</div>' +
                    '<div class="card-count">' + cardCount + '</div>';

                container.appendChild(div);
            }
        }

        function renderDiscard() {
            var container = document.getElementById('discardPile');
            var colorDot = document.getElementById('colorDot');
            
            var top = gameState.discardPile[gameState.discardPile.length - 1];
            if (top) {
                container.innerHTML = createCardHtml(top);
            }

            if (gameState.currentColor) {
                colorDot.className = 'color-dot ' + gameState.currentColor;
            }
        }

        function renderHand() {
            var container = document.getElementById('playerHand');
            var countEl = document.getElementById('playerCardCount');
            var player = gameState.players[0];
            var isMyTurn = gameState.currentPlayer === 0 && !gameState.gameOver;

            container.innerHTML = '';

            for (var i = 0; i < player.hand.length; i++) {
                var card = player.hand[i];
                var canPlay = isMyTurn && isPlayable(card);

                var cardDiv = document.createElement('div');
                cardDiv.innerHTML = createCardHtml(card);
                var cardEl = cardDiv.firstChild;

                if (isMyTurn) {
                    if (canPlay) {
                        cardEl.classList.add('playable');
                        (function(index) {
                            cardEl.onclick = function() { playCard(index); };
                        })(i);
                    } else {
                        cardEl.classList.add('not-playable');
                    }
                }

                container.appendChild(cardEl);
            }

            countEl.textContent = player.hand.length + ' carta' + (player.hand.length !== 1 ? 's' : '');
        }

        function createCardHtml(card) {
            var colorClass = (card.type === 'wild' || card.type === 'wild4') ? 'wild' : card.color;
            var display = getDisplayValue(card);

            return '<div class="uno-card ' + colorClass + '">' +
                '<span class="card-corner top">' + display + '</span>' +
                '<span class="card-value">' + display + '</span>' +
                '<span class="card-corner bottom">' + display + '</span>' +
                '</div>';
        }

        function getDisplayValue(card) {
            switch(card.type) {
                case 'skip': return '‚äò';
                case 'reverse': return '‚ü≤';
                case 'draw2': return '+2';
                case 'wild': return '‚òÖ';
                case 'wild4': return '+4';
                default: return card.value;
            }
        }

        function renderTurnInfo() {
            var nameEl = document.getElementById('turnName');
            var arrowEl = document.getElementById('directionArrow');
            
            nameEl.textContent = gameState.players[gameState.currentPlayer].name;
            arrowEl.textContent = gameState.direction === 1 ? '‚û°Ô∏è' : '‚¨ÖÔ∏è';
        }

        function renderButtons() {
            var unoBtn = document.getElementById('unoButton');
            var passBtn = document.getElementById('passButton');
            var player = gameState.players[0];
            var isMyTurn = gameState.currentPlayer === 0;

            // UNO button active when player has 2 cards and it's their turn
            if (isMyTurn && player.hand.length === 2 && !gameState.calledUno) {
                unoBtn.classList.add('active');
            } else {
                unoBtn.classList.remove('active');
            }

            // Pass button visible after drawing
            if (isMyTurn && gameState.drawnThisTurn) {
                passBtn.classList.add('visible');
            } else {
                passBtn.classList.remove('visible');
            }
        }

        // ==================== GAME LOGIC ====================
        function isPlayable(card) {
            if (card.type === 'wild' || card.type === 'wild4') return true;
            if (card.color === gameState.currentColor) return true;
            if (card.value === gameState.currentValue) return true;
            return false;
        }

        function playCard(index) {
            if (gameState.gameOver) return;
            if (gameState.currentPlayer !== 0) return;

            var player = gameState.players[0];
            var card = player.hand[index];

            if (!isPlayable(card)) {
                showToast('No puedes jugar esta carta', 'error');
                return;
            }

            // Remove from hand
            player.hand.splice(index, 1);

            // Wild card - pick color
            if (card.type === 'wild' || card.type === 'wild4') {
                gameState.pendingWild = card;
                document.getElementById('colorPicker').classList.add('active');
                return;
            }

            executePlay(card, null);
        }

        function selectColor(color) {
            document.getElementById('colorPicker').classList.remove('active');
            
            if (gameState.pendingWild) {
                var card = gameState.pendingWild;
                gameState.pendingWild = null;
                showToast('Elegiste ' + translateColor(color), 'success');
                executePlay(card, color);
            }
        }

        function executePlay(card, chosenColor) {
            gameState.discardPile.push(card);
            gameState.currentColor = chosenColor || card.color;
            gameState.currentValue = card.value;
            gameState.drawnThisTurn = false;

            var player = gameState.players[gameState.currentPlayer];

            // Check winner
            if (player.hand.length === 0) {
                endGame(player);
                return;
            }

            // UNO penalty
            if (gameState.currentPlayer === 0 && player.hand.length === 1 && !gameState.calledUno) {
                showToast('¬°No dijiste UNO! +2 cartas', 'warning');
                dealCards(2, player);
            }
            gameState.calledUno = false;

            // Apply special effects
            applyCardEffect(card);

            nextTurn();
        }

        function applyCardEffect(card) {
            var nextIdx = getNextPlayer();
            var nextPlayer = gameState.players[nextIdx];

            switch(card.type) {
                case 'skip':
                    showToast(nextPlayer.name + ' pierde turno', 'info');
                    advancePlayer(); // Skip
                    break;
                case 'reverse':
                    gameState.direction *= -1;
                    showToast('¬°Direcci√≥n invertida!', 'info');
                    if (gameState.players.length === 2) advancePlayer();
                    break;
                case 'draw2':
                    dealCards(2, nextPlayer);
                    showToast(nextPlayer.name + ' roba 2', 'warning');
                    advancePlayer();
                    break;
                case 'wild4':
                    dealCards(4, nextPlayer);
                    showToast(nextPlayer.name + ' roba 4', 'warning');
                    advancePlayer();
                    break;
            }
        }

        function getNextPlayer() {
            var next = gameState.currentPlayer + gameState.direction;
            if (next >= gameState.players.length) next = 0;
            if (next < 0) next = gameState.players.length - 1;
            return next;
        }

        function advancePlayer() {
            gameState.currentPlayer = getNextPlayer();
        }

        function nextTurn() {
            advancePlayer();
            gameState.drawnThisTurn = false;
            gameState.calledUno = false;
            render();

            if (gameState.players[gameState.currentPlayer].isAI && !gameState.gameOver) {
                setTimeout(aiTurn, 1000);
            }
        }

        function drawCard() {
            if (gameState.gameOver) return;
            if (gameState.currentPlayer !== 0) {
                showToast('No es tu turno', 'error');
                return;
            }
            if (gameState.drawnThisTurn) {
                showToast('Ya robaste. Puedes pasar.', 'info');
                return;
            }

            var player = gameState.players[0];
            dealCards(1, player);
            gameState.drawnThisTurn = true;
            showToast('Robaste una carta', 'info');
            render();
        }

        function passTurn() {
            if (gameState.currentPlayer !== 0) return;
            if (!gameState.drawnThisTurn) {
                showToast('Primero debes robar', 'error');
                return;
            }
            showToast('Pasas turno', 'info');
            nextTurn();
        }

        function callUno() {
            var player = gameState.players[0];
            if (player.hand.length <= 2) {
                gameState.calledUno = true;
                showToast('¬°UNO! üéâ', 'success');
                render();
            } else {
                showToast('Solo con 1-2 cartas', 'error');
            }
        }

        // ==================== AI ====================
        function aiTurn() {
            if (gameState.gameOver) return;
            
            var player = gameState.players[gameState.currentPlayer];
            if (!player.isAI) return;

            // Find playable cards
            var playable = [];
            for (var i = 0; i < player.hand.length; i++) {
                if (isPlayable(player.hand[i])) {
                    playable.push({card: player.hand[i], index: i});
                }
            }

            if (playable.length > 0) {
                // Sort by priority
                playable.sort(function(a, b) {
                    return cardPriority(b.card) - cardPriority(a.card);
                });

                var chosen = playable[0];
                player.hand.splice(chosen.index, 1);

                // UNO call
                if (player.hand.length === 1) {
                    setTimeout(function() { showToast(player.name + ': ¬°UNO!', 'warning'); }, 400);
                }

                // Wild card
                if (chosen.card.type === 'wild' || chosen.card.type === 'wild4') {
                    var color = chooseBestColor(player);
                    showToast(player.name + ' elige ' + translateColor(color), 'info');
                    
                    gameState.discardPile.push(chosen.card);
                    gameState.currentColor = color;
                    gameState.currentValue = chosen.card.value;

                    if (player.hand.length === 0) {
                        endGame(player);
                        return;
                    }

                    if (chosen.card.type === 'wild4') {
                        var nextP = gameState.players[getNextPlayer()];
                        dealCards(4, nextP);
                        showToast(nextP.name + ' roba 4', 'warning');
                        advancePlayer();
                    }

                    nextTurn();
                    return;
                }

                showToast(player.name + ' juega ' + getDisplayValue(chosen.card), 'info');
                executePlay(chosen.card, null);

            } else {
                // Draw
                dealCards(1, player);
                showToast(player.name + ' roba', 'info');
                
                var drawn = player.hand[player.hand.length - 1];
                
                if (isPlayable(drawn)) {
                    setTimeout(function() {
                        player.hand.pop();
                        
                        if (drawn.type === 'wild' || drawn.type === 'wild4') {
                            var color = chooseBestColor(player);
                            showToast(player.name + ' juega y elige ' + translateColor(color), 'info');
                            
                            gameState.discardPile.push(drawn);
                            gameState.currentColor = color;
                            gameState.currentValue = drawn.value;

                            if (drawn.type === 'wild4') {
                                var np = gameState.players[getNextPlayer()];
                                dealCards(4, np);
                                advancePlayer();
                            }

                            if (player.hand.length === 0) {
                                endGame(player);
                                return;
                            }

                            nextTurn();
                        } else {
                            showToast(player.name + ' juega carta robada', 'info');
                            executePlay(drawn, null);
                        }
                    }, 700);
                    return;
                }

                setTimeout(function() {
                    showToast(player.name + ' pasa', 'info');
                    nextTurn();
                }, 500);
            }
        }

        function cardPriority(card) {
            switch(card.type) {
                case 'wild4': return 100;
                case 'wild': return 90;
                case 'draw2': return 80;
                case 'skip': return 70;
                case 'reverse': return 60;
                default: return parseInt(card.value) || 0;
            }
        }

        function chooseBestColor(player) {
            var count = {red: 0, blue: 0, green: 0, yellow: 0};
            for (var i = 0; i < player.hand.length; i++) {
                var c = player.hand[i].color;
                if (c && c !== 'wild') count[c]++;
            }
            
            var best = 'red';
            var max = 0;
            for (var color in count) {
                if (count[color] > max) {
                    max = count[color];
                    best = color;
                }
            }
            return best;
        }

        function translateColor(color) {
            var names = {red: 'Rojo', blue: 'Azul', green: 'Verde', yellow: 'Amarillo'};
            return names[color] || color;
        }

        // ==================== END GAME ====================
        function endGame(winner) {
            gameState.gameOver = true;
            document.getElementById('winnerName').textContent = '¬°' + winner.name + ' gana!';
            document.getElementById('winnerModal').classList.add('active');
        }

        function backToMenu() {
            document.getElementById('winnerModal').classList.remove('active');
            showScreen('menuScreen');
        }

        // ==================== RULES ====================
        function showRules() {
            document.getElementById('rulesModal').classList.add('active');
        }

        function hideRules() {
            document.getElementById('rulesModal').classList.remove('active');
        }
    </script>
</body>
</html>
